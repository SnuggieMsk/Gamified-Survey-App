<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-Powered Product Survey</title>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px 0;
    }
    button:hover {
      background-color: #3367d6;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    textarea {
      height: 100px;
    }
    .card {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .flashcard {
      display: none;
      text-align: center;
      min-height: 200px;
      position: relative;
      padding: 20px;
    }
    .question {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .option-btn {
      padding: 10px;
      background-color: #e8f0fe;
      border: 1px solid #ccc;
      color: #333;
    }
    .option-btn:hover {
      background-color: #d2e3fc;
    }
    .progress {
      margin-top: 20px;
      height: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background-color: #4285f4;
      width: 0%;
      transition: width 0.3s;
    }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    #uploadSection {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    #uploadSection img {
      max-width: 100%;
      max-height: 300px;
      margin-top: 10px;
    }
    #status {
      color: #4CAF50;
      margin: 10px 0;
    }
    #error {
      color: #F44336;
      margin: 10px 0;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 10px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI-Powered Product Survey</h1>
    
    <!-- Setup Section (for survey creation) -->
    <div id="setupSection">
      <div class="card">
        <h2>Step 1: Upload Product Information</h2>
        <div id="uploadSection">
          <label for="productImage">Upload Product Image:</label>
          <input type="file" id="productImage" accept="image/*" />
          <div id="productImagePreview"></div>
        </div>
        <div class="input-group">
          <label for="productName">Product Name:</label>
          <input type="text" id="productName" placeholder="Enter product name" />
        </div>
        <div class="input-group">
          <label for="productDescription">Product Description:</label>
          <textarea id="productDescription" placeholder="Enter detailed product description"></textarea>
        </div>
        <div class="input-group">
          <label for="studyParameters">Study Parameters:</label>
          <textarea id="studyParameters" placeholder="Enter what you want to study about this product (e.g., user experience, design preferences, pricing)"></textarea>
        </div>
        <div class="input-group">
          <label for="numQuestions">Number of Questions:</label>
          <input type="number" id="numQuestions" min="1" max="20" value="5" />
        </div>
        <button id="generateQuestionsBtn">Generate Questions with AI</button>
        <div class="loader" id="aiLoader"></div>
        <div id="status"></div>
        <div id="error"></div>
      </div>
      
      <!-- Review Section for the creator -->
      <div class="card hidden" id="questionPreviewSection">
        <h2>Step 2: Review Generated Questions</h2>
        <div id="generatedQuestionsPreview"></div>
        <button id="editQuestionsBtn">Edit Questions</button>
        <button id="startSurveyBtn">Start Survey</button>
        <button id="publishSurveyBtnAdmin">Publish Survey</button>
      </div>
      
      <div class="card hidden" id="authSection">
        <h2>Step 3: Connect Google Sheets</h2>
        <p>To save survey responses, please connect to your Google account:</p>
        <div id="googleAuthButton"></div>
        <div id="authStatus"></div>
      </div>
    </div>
    
    <!-- Survey Section (for both admin mode and published/respondent mode) -->
    <div id="surveySection" class="hidden">
      <h2>Product Survey</h2>
      <div class="flashcard" id="surveyFlashcard">
        <div class="question" id="currentQuestion"></div>
        <div class="options" id="optionsContainer"></div>
        <div class="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="nav-buttons">
          <button id="prevBtn" disabled>Previous</button>
          <button id="nextBtn" disabled>Next</button>
        </div>
      </div>
      <div class="hidden" id="surveyCompleteSection">
        <h2>Survey Complete!</h2>
        <p>Thank you for completing the survey. Your responses have been recorded.</p>
        <button id="newSurveyBtn">Create New Survey</button>
        <button id="shareSurveyBtn">Share Survey</button>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let productData = {
      name: '',
      description: '',
      imageUrl: '',
      studyParameters: ''
    };
    let questions = [];
    let currentQuestionIndex = 0;
    let responses = [];
    let googleSheetsInitialized = false;
    const GEMINI_API_KEY = "AIzaSyA8R_U1pHmh78Qs3q1PWbAJF_qTgsDFGBc";
    // Google Apps Script endpoint URL (backend)
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxr0dsUlNKFttZ3Vy6o8WhNNI3QdF0xxXICEOQwTj6kEuFD3l9xGqtZeOh3hvX6hfrC/exec";
    // Flag to indicate published (respondent) mode
    let isPublishedMode = false;
    
    // Global variables for survey storage
    let surveyID = null; // Unique ID for each survey
    const STORAGE_PREFIX = "survey_app_";
    
    // Generate a unique ID for surveys
    function generateUniqueID() {
      return 'survey_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Generate questions via Gemini API
    function generateQuestions() {
      if (!validateInputs()) return;
      aiLoader.style.display = 'block';
      statusDiv.textContent = 'Generating questions...';
      errorDiv.textContent = '';
      
      // Update productData with current form values
      productData = {
        name: productNameInput.value.trim(),
        description: productDescriptionInput.value.trim(),
        imageUrl: productData.imageUrl,
        studyParameters: studyParametersInput.value.trim()
      };
      
      const numQuestions = parseInt(numQuestionsInput.value);
      
      // Prepare prompt for Gemini API
      const prompt = `Generate ${numQuestions} survey questions about the following product:
      
Product Name: ${productData.name}
Product Description: ${productData.description}
Study Parameters: ${productData.studyParameters}

For each question, provide 4-5 options as answers. The questions should help understand user preferences, opinions, and feedback about the product. Format your response as a JSON array with this structure:
[
  {
    "question": "Question text here",
    "options": ["Option 1", "Option 2", "Option 3", "Option 4"]
  }
]`;
      
      // Call Gemini API
      fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: prompt
                }
              ]
            }
          ],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 1024
          }
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Extract the generated content
        const generatedText = data.candidates[0].content.parts[0].text;
        
        // Find and extract the JSON part
        const jsonMatch = generatedText.match(/\[\s*\{[\s\S]*\}\s*\]/);
        if (!jsonMatch) {
          throw new Error('Could not parse JSON from the API response');
        }
        
        // Parse the JSON
        try {
          const parsedQuestions = JSON.parse(jsonMatch[0]);
          
          // Validate the question format
          if (!Array.isArray(parsedQuestions) || parsedQuestions.length === 0) {
            throw new Error('Invalid question format returned from API');
          }
          
          // Ensure each question has the required fields
          questions = parsedQuestions.map(q => {
            if (!q.question || !Array.isArray(q.options) || q.options.length === 0) {
              throw new Error('Invalid question or options format');
            }
            return {
              question: q.question,
              options: q.options
            };
          });
          
          // Display the generated questions
          displayQuestionsForReview(questions);
          aiLoader.style.display = 'none';
          statusDiv.textContent = 'Questions generated successfully!';
          questionPreviewSection.classList.remove('hidden');
        } catch (parseError) {
          console.error('Error parsing questions:', parseError);
          // Fallback to sample questions if parsing fails
          questions = generateSampleQuestions(productData, numQuestions);
          displayQuestionsForReview(questions);
          aiLoader.style.display = 'none';
          statusDiv.textContent = 'Generated sample questions (API parsing failed).';
          questionPreviewSection.classList.remove('hidden');
        }
      })
      .catch(error => {
        console.error('Error calling Gemini API:', error);
        // Fallback to sample questions in case of API failure
        questions = generateSampleQuestions(productData, numQuestions);
        displayQuestionsForReview(questions);
        aiLoader.style.display = 'none';
        errorDiv.textContent = `Error with AI API: ${error.message}. Fell back to sample questions.`;
        questionPreviewSection.classList.remove('hidden');
      });
    }
    
    // Fallback function to generate sample questions
    function generateSampleQuestions(productData, numQuestions) {
      const questionTypes = [
        `How would you rate the overall design of the ${productData.name}?`,
        `What feature of the ${productData.name} do you find most appealing?`,
        `How likely are you to recommend the ${productData.name} to a friend?`,
        `What would make you purchase the ${productData.name}?`,
        `How much would you be willing to pay for the ${productData.name}?`,
        `What improvement would you suggest for the ${productData.name}?`,
        `How does the ${productData.name} compare to similar products you've used?`,
        `What is your first impression of the ${productData.name}?`,
        `How important is sustainability in your decision to purchase the ${productData.name}?`,
        `What colors would you prefer for the ${productData.name}?`
      ];
      const sampleQuestions = [];
      const questionsToGenerate = Math.min(numQuestions, questionTypes.length);
      const selectedQuestionIndices = new Set();
      while (selectedQuestionIndices.size < questionsToGenerate) {
        selectedQuestionIndices.add(Math.floor(Math.random() * questionTypes.length));
      }
      Array.from(selectedQuestionIndices).forEach(index => {
        const question = questionTypes[index];
        let options = [];
        if (question.includes('rate')) {
          options = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        } else if (question.includes('likely')) {
          options = ['Not at all likely', 'Somewhat unlikely', 'Neutral', 'Somewhat likely', 'Very likely'];
        } else if (question.includes('willing to pay')) {
          options = ['$10-$20', '$21-$50', '$51-$100', '$101-$200', 'More than $200'];
        } else if (question.includes('colors')) {
          options = ['Black', 'White', 'Blue', 'Red', 'Green'];
        } else if (question.includes('important')) {
          options = ['Not important', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'];
        } else {
          options = ['Option 1', 'Option 2', 'Option 3', 'Option 4'];
        }
        sampleQuestions.push({
          question: question,
          options: options
        });
      });
      return sampleQuestions;
    }
    
    // Function to check if the API key is valid
    function isValidApiKey(key) {
      return key && key.length > 20 && !key.includes("YOUR_API_KEY");
    }
    
    // Validate API key on load
    function validateApiKey() {
      if (!isValidApiKey(GEMINI_API_KEY)) {
        errorDiv.textContent = 'Warning: API key may be invalid or missing. The app will use sample questions instead.';
        errorDiv.style.backgroundColor = '#ffffd0';
        errorDiv.style.padding = '10px';
        errorDiv.style.borderRadius = '5px';
        errorDiv.style.marginBottom = '15px';
      }
    }
    
    // Replace the existing initGoogleSheetsAPI function with this:
    function initGoogleSheetsAPI() {
      // For simplicity, we'll use a direct CORS request to the Google Apps Script
      // No need for full gapi.client initialization in this implementation
      googleSheetsInitialized = true;
      // Update auth status message
      authStatus.textContent = "Connected to Google Sheets. Responses will be stored in Google Sheets.";
      // Make the auth section visible
      authSection.classList.remove('hidden');
    }
    
    // --- Survey Publishing & Management Functions ---
    
    // Modify the publishSurvey function to save the survey data first
    function publishSurvey() {
      if (!questions || questions.length === 0) {
        alert("No survey questions available to publish!");
        return;
      }
      
      // Generate a unique ID if we don't have one yet
      if (!surveyID) {
        surveyID = generateUniqueID();
      }
      
      // Create a survey object with all relevant data
      const surveyData = {
        id: surveyID,
        title: productData.name,
        description: productData.description,
        studyParameters: productData.studyParameters,
        imageUrl: productData.imageUrl,
        questions: questions,
        createdDate: new Date().toISOString(),
        responses: [] // Initialize with empty responses array
      };
      
      // Save to localStorage
      localStorage.setItem(STORAGE_PREFIX + surveyID, JSON.stringify(surveyData));
      
      // Also save to the list of available surveys
      let surveyList = JSON.parse(localStorage.getItem(STORAGE_PREFIX + "survey_list") || "[]");
      if (!surveyList.includes(surveyID)) {
        surveyList.push(surveyID);
        localStorage.setItem(STORAGE_PREFIX + "survey_list", JSON.stringify(surveyList));
      }
      
      // Now create the shareable URL with the survey ID
      const shareableUrl = window.location.origin + window.location.pathname + "?survey=" + encodeURIComponent(surveyID);
      
      navigator.clipboard.writeText(shareableUrl).then(() => {
        alert("Survey published! Shareable link copied to clipboard:\n" + shareableUrl);
      }).catch(() => {
        prompt("Survey published! Copy this URL:", shareableUrl);
      });
    }
    
    // Update getSurveyFromUrl to handle either encoded survey data or survey ID
    function getSurveyFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const surveyParam = params.get("survey");
      
      if (!surveyParam) return null;
      
      // First, try to load as a survey ID from localStorage
      const storedSurvey = localStorage.getItem(STORAGE_PREFIX + surveyParam);
      if (storedSurvey) {
        return { type: "id", value: surveyParam };
      }
      
      // If not found in localStorage, try to decode as base64 JSON (legacy support)
      try {
        const decoded = atob(surveyParam);
        JSON.parse(decoded); // Validate
        return { type: "data", value: surveyParam };
      } catch (e) {
        console.error("Failed to parse survey data from URL", e);
        return null;
      }
    }
    
    // Update the init function to include API validation and survey loading
    function init() {
      // Set up event listeners
      generateQuestionsBtn.addEventListener('click', generateQuestions);
      editQuestionsBtn.addEventListener('click', editQuestions);
      startSurveyBtn.addEventListener('click', startSurvey);
      publishSurveyBtnAdmin.addEventListener('click', publishSurvey);
      prevBtn.addEventListener('click', showPreviousQuestion);
      nextBtn.addEventListener('click', showNextQuestion);
      newSurveyBtn.addEventListener('click', resetSurvey);
      shareSurveyBtn.addEventListener('click', shareSurvey);
      productImageInput.addEventListener('change', handleImageUpload);
      
      // Add a new button to view all surveys and export responses
      const manageSurveysBtn = document.createElement('button');
      manageSurveysBtn.id = 'manageSurveysBtn';
      manageSurveysBtn.textContent = 'Manage Surveys';
      manageSurveysBtn.addEventListener('click', showSurveyManager);
      newSurveyBtn.parentNode.appendChild(manageSurveysBtn);
      
      // Validate API key on load
      validateApiKey();
      
      // Check if a published survey is provided via URL
      const surveyParam = getSurveyFromUrl();
      if (surveyParam) {
        if (surveyParam.type === "id") {
          // Load from localStorage by ID
          loadSurveyById(surveyParam.value);
        } else {
          // Legacy: Load from encoded data
          try {
            const decoded = atob(surveyParam.value);
            questions = JSON.parse(decoded);
            productData.name = "Published Survey";
            isPublishedMode = true;
            setupSection.style.display = "none";
            questionPreviewSection.style.display = "none";
            surveySection.classList.remove("hidden");
            surveyFlashcard.style.display = "block";
            currentQuestionIndex = 0;
            responses = Array(questions.length).fill(null);
            displayCurrentQuestion();
          } catch (e) {
            console.error("Failed to parse survey data from URL", e);
          }
        }
      }
    }
    
    // Function to load a survey by ID
    function loadSurveyById(id) {
      const storedSurveyJSON = localStorage.getItem(STORAGE_PREFIX + id);
      if (!storedSurveyJSON) {
        alert('Survey not found!');
        return;
      }
      
      const storedSurvey = JSON.parse(storedSurveyJSON);
      surveyID = storedSurvey.id;
      questions = storedSurvey.questions;
      
      if (!isPublishedMode) {
        // Admin mode - loading for editing
        productData = {
          name: storedSurvey.title || "Unnamed Survey",
          description: storedSurvey.description || "",
          studyParameters: storedSurvey.studyParameters || "",
          imageUrl: storedSurvey.imageUrl || ""
        };
        
        // Fill the form fields
        productNameInput.value = productData.name;
        productDescriptionInput.value = productData.description;
        studyParametersInput.value = productData.studyParameters;
        
        if (productData.imageUrl) {
          const img = document.createElement('img');
          img.src = productData.imageUrl;
          productImagePreview.innerHTML = '';
          productImagePreview.appendChild(img);
        }
        
        displayQuestionsForReview(questions);
        questionPreviewSection.classList.remove('hidden');
      } else {
        // Respondent mode - taking the survey
        productData.name = storedSurvey.title || "Published Survey";
        setupSection.style.display = "none";
        questionPreviewSection.style.display = "none";
        surveySection.classList.remove("hidden");
        surveyFlashcard.style.display = "block";
        currentQuestionIndex = 0;
        responses = Array(questions.length).fill(null);
        displayCurrentQuestion();
      }
    }
    
    // Start the survey (admin mode) – switch from creation to taking the survey
    function startSurvey() {
      responses = Array(questions.length).fill(null);
      setupSection.classList.add('hidden');
      surveySection.classList.remove('hidden');
      surveyFlashcard.style.display = 'block';
      currentQuestionIndex = 0;
      displayCurrentQuestion();
    }
    
    // Display the current question for taking the survey
    function displayCurrentQuestion() {
      const question = questions[currentQuestionIndex];
      currentQuestionElement.textContent = question.question;
      optionsContainer.innerHTML = '';
      question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.className = 'option-btn';
        if (responses[currentQuestionIndex] === index) {
          button.style.backgroundColor = '#4285f4';
          button.style.color = 'white';
        }
        button.addEventListener('click', () => {
          document.querySelectorAll('.option-btn').forEach(btn => {
            btn.style.backgroundColor = '#e8f0fe';
            btn.style.color = '#333';
          });
          button.style.backgroundColor = '#4285f4';
          button.style.color = 'white';
          responses[currentQuestionIndex] = index;
          nextBtn.disabled = false;
        });
        optionsContainer.appendChild(button);
      });
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressBar.style.width = `${progress}%`;
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = responses[currentQuestionIndex] === null;
    }
    
    // Navigate to the previous question
    function showPreviousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayCurrentQuestion();
      }
    }
    
    // Navigate to the next question or finish the survey
    function showNextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        displayCurrentQuestion();
      } else {
        finishSurvey();
      }
    }
    
    // Update finishSurvey to store responses locally
    function finishSurvey() {
      const formattedResponses = questions.map((q, index) => ({
        question: q.question,
        selectedOption: q.options[responses[index]],
        optionIndex: responses[index]
      }));
      
      if (!productData.name) productData.name = "Published Survey";
      
      // Store responses locally
      saveSurveyResponse(formattedResponses);
      
      surveyFlashcard.style.display = 'none';
      surveyCompleteSection.classList.remove('hidden');
      
      const statusMessage = document.createElement('p');
      statusMessage.id = 'submitStatus';
      statusMessage.textContent = '✅ Your responses have been recorded. Thank you!';
      statusMessage.style.color = '#4CAF50';
      if (!document.getElementById('submitStatus')) {
        surveyCompleteSection.prepend(statusMessage);
      }
    }
    
    // Function to save survey responses
    function saveSurveyResponse(formattedResponses) {
      if (!surveyID) {
        console.error("No survey ID found");
        return;
      }
      
      const storedSurveyJSON = localStorage.getItem(STORAGE_PREFIX + surveyID);
      if (!storedSurveyJSON) {
        console.error("Survey not found:", surveyID);
        return;
      }
      
      const surveyData = JSON.parse(storedSurveyJSON);
      
      const newResponse = {
        id: 'resp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        timestamp: new Date().toISOString(),
        answers: formattedResponses
      };
      
      surveyData.responses.push(newResponse);
      
      localStorage.setItem(STORAGE_PREFIX + surveyID, JSON.stringify(surveyData));
      
      console.log("Response saved:", newResponse);
    }
    
    // Function to show the survey manager UI
    function showSurveyManager() {
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '1000';
      
      const modalContent = document.createElement('div');
      modalContent.style.backgroundColor = 'white';
      modalContent.style.padding = '20px';
      modalContent.style.borderRadius = '10px';
      modalContent.style.maxWidth = '800px';
      modalContent.style.width = '90%';
      modalContent.style.maxHeight = '80vh';
      modalContent.style.overflow = 'auto';
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.float = 'right';
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      const title = document.createElement('h2');
      title.textContent = 'Manage Your Surveys';
      
      modalContent.appendChild(closeBtn);
      modalContent.appendChild(title);
      
      const surveyList = JSON.parse(localStorage.getItem(STORAGE_PREFIX + "survey_list") || "[]");
      
      if (surveyList.length === 0) {
        const noSurveys = document.createElement('p');
        noSurveys.textContent = 'No surveys found.';
        modalContent.appendChild(noSurveys);
      } else {
        const surveyTable = document.createElement('table');
        surveyTable.style.width = '100%';
        surveyTable.style.borderCollapse = 'collapse';
        surveyTable.style.marginTop = '20px';
        
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Survey Title', 'Created Date', 'Responses', 'Actions'].forEach(text => {
          const th = document.createElement('th');
          th.textContent = text;
          th.style.padding = '10px';
          th.style.textAlign = 'left';
          th.style.borderBottom = '2px solid #ddd';
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        surveyTable.appendChild(thead);
        
        const tbody = document.createElement('tbody');
        
        surveyList.forEach(surveyId => {
          const surveyData = JSON.parse(localStorage.getItem(STORAGE_PREFIX + surveyId) || "null");
          if (!surveyData) return;
          
          const row = document.createElement('tr');
          row.style.borderBottom = '1px solid #ddd';
          
          const titleCell = document.createElement('td');
          titleCell.textContent = surveyData.title || "Unnamed Survey";
          titleCell.style.padding = '10px';
          row.appendChild(titleCell);
          
          const dateCell = document.createElement('td');
          const createdDate = surveyData.createdDate ? new Date(surveyData.createdDate) : new Date();
          dateCell.textContent = createdDate.toLocaleDateString();
          dateCell.style.padding = '10px';
          row.appendChild(dateCell);
          
          const responsesCell = document.createElement('td');
          const responseCount = surveyData.responses ? surveyData.responses.length : 0;
          responsesCell.textContent = responseCount;
          responsesCell.style.padding = '10px';
          row.appendChild(responsesCell);
          
          const actionsCell = document.createElement('td');
          actionsCell.style.padding = '10px';
          
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.style.marginRight = '5px';
          editBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
            loadSurveyById(surveyId);
          });
          actionsCell.appendChild(editBtn);
          
          const exportBtn = document.createElement('button');
          exportBtn.textContent = 'Export CSV';
          exportBtn.disabled = responseCount === 0;
          exportBtn.addEventListener('click', () => {
            exportResponsesAsCSV(surveyId);
          });
          actionsCell.appendChild(exportBtn);
          
          const shareBtn = document.createElement('button');
          shareBtn.textContent = 'Share';
          shareBtn.style.marginLeft = '5px';
          shareBtn.addEventListener('click', () => {
            const shareableUrl = window.location.origin + window.location.pathname + "?survey=" + encodeURIComponent(surveyId);
            navigator.clipboard.writeText(shareableUrl).then(() => {
              alert("Shareable link copied to clipboard:\n" + shareableUrl);
            }).catch(() => {
              prompt("Copy this URL:", shareableUrl);
            });
          });
          actionsCell.appendChild(shareBtn);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.style.marginLeft = '5px';
          deleteBtn.style.backgroundColor = '#ff4444';
          deleteBtn.addEventListener('click', () => {
            if (confirm(`Are you sure you want to delete "${surveyData.title || "Unnamed Survey"}"? This will delete all responses as well.`)) {
              localStorage.removeItem(STORAGE_PREFIX + surveyId);
              const updatedList = surveyList.filter(id => id !== surveyId);
              localStorage.setItem(STORAGE_PREFIX + "survey_list", JSON.stringify(updatedList));
              row.remove();
              if (tbody.children.length === 0) {
                const noSurveys = document.createElement('p');
                noSurveys.textContent = 'No surveys found.';
                modalContent.replaceChild(noSurveys, surveyTable);
              }
            }
          });
          actionsCell.appendChild(deleteBtn);
          
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });
        
        surveyTable.appendChild(tbody);
        modalContent.appendChild(surveyTable);
      }
      
      if (surveyList.length > 0) {
        const clearAllBtn = document.createElement('button');
        clearAllBtn.textContent = 'Clear All Surveys';
        clearAllBtn.style.marginTop = '20px';
        clearAllBtn.style.backgroundColor = '#ff4444';
        clearAllBtn.addEventListener('click', () => {
          if (confirm("Are you sure you want to delete ALL surveys and their responses? This cannot be undone.")) {
            surveyList.forEach(surveyId => {
              localStorage.removeItem(STORAGE_PREFIX + surveyId);
            });
            localStorage.removeItem(STORAGE_PREFIX + "survey_list");
            document.body.removeChild(modal);
            showSurveyManager();
          }
        });
        modalContent.appendChild(clearAllBtn);
      }
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }
    
    // Function to export survey responses as CSV
    function exportResponsesAsCSV(surveyId) {
      const surveyData = JSON.parse(localStorage.getItem(STORAGE_PREFIX + surveyId));
      if (!surveyData || !surveyData.responses || surveyData.responses.length === 0) {
        alert('No responses to export!');
        return;
      }
      
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Survey Title:," + (surveyData.title || "Unnamed Survey") + "\r\n";
      csvContent += "Survey Description:," + (surveyData.description || "") + "\r\n";
      csvContent += "Study Parameters:," + (surveyData.studyParameters || "") + "\r\n";
      csvContent += "Total Responses:," + surveyData.responses.length + "\r\n\r\n";
      
      const headerRow = ["Response ID", "Timestamp"];
      surveyData.questions.forEach(question => {
        headerRow.push(question.question);
      });
      csvContent += headerRow.join(",") + "\r\n";
      
      surveyData.responses.forEach(response => {
        const row = [ response.id, response.timestamp ];
        surveyData.questions.forEach((question, qIndex) => {
          const answer = response.answers.find(a => a.question === question.question);
          row.push(answer ? answer.selectedOption : "No response");
        });
        csvContent += row.join(",") + "\r\n";
      });
      
      csvContent += "\r\nSUMMARY STATISTICS\r\n";
      csvContent += "Question,Option,Count,Percentage\r\n";
      
      surveyData.questions.forEach(question => {
        const optionCounts = {};
        let totalResponses = 0;
        surveyData.responses.forEach(response => {
          const answer = response.answers.find(a => a.question === question.question);
          if (answer) {
            optionCounts[answer.selectedOption] = (optionCounts[answer.selectedOption] || 0) + 1;
            totalResponses++;
          }
        });
        Object.keys(optionCounts).forEach(option => {
          const count = optionCounts[option];
          const percentage = (count / totalResponses * 100).toFixed(2) + "%";
          csvContent += `"${question.question}","${option}",${count},${percentage}\r\n`;
        });
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `survey_responses_${surveyData.title || "unnamed"}_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // In admin mode: Share survey from the respondent side
    function shareSurvey() {
      const surveyUrl = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'Take my survey',
          text: 'Check out this survey!',
          url: surveyUrl,
        }).then(() => {
          console.log('Survey shared successfully');
        }).catch((error) => {
          console.error('Error sharing survey:', error);
        });
      } else {
        navigator.clipboard.writeText(surveyUrl).then(() => {
          alert('Survey link copied to clipboard');
        }).catch((error) => {
          alert('Error copying link to clipboard: ' + error);
        });
      }
    }
    
    // References for elements (for API key validation)
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const productNameInput = document.getElementById('productName');
    const productDescriptionInput = document.getElementById('productDescription');
    const studyParametersInput = document.getElementById('studyParameters');
    const numQuestionsInput = document.getElementById('numQuestions');
    const productImageInput = document.getElementById('productImage');
    const productImagePreview = document.getElementById('productImagePreview');
    const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
    const editQuestionsBtn = document.getElementById('editQuestionsBtn');
    const startSurveyBtn = document.getElementById('startSurveyBtn');
    const publishSurveyBtnAdmin = document.getElementById('publishSurveyBtnAdmin');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const newSurveyBtn = document.getElementById('newSurveyBtn');
    const shareSurveyBtn = document.getElementById('shareSurveyBtn');
    const generatedQuestionsPreview = document.getElementById('generatedQuestionsPreview');
    const questionPreviewSection = document.getElementById('questionPreviewSection');
    const setupSection = document.getElementById('setupSection');
    const surveySection = document.getElementById('surveySection');
    const surveyFlashcard = document.getElementById('surveyFlashcard');
    const surveyCompleteSection = document.getElementById('surveyCompleteSection');
    const currentQuestionElement = document.getElementById('currentQuestion');
    const optionsContainer = document.getElementById('optionsContainer');
    const progressBar = document.getElementById('progressBar');
    const aiLoader = document.getElementById('aiLoader');
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
